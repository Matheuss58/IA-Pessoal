<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Minha IA Local — Chat</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#3b82f6; --muted:#94a3b8;
    --user:#0ea5a4; --assistant:#10b981; --radius:12px; --gap:12px;
  }
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;background:linear-gradient(180deg,#071024 0%, #081424 100%);color:#e6eef8}
  .container{max-width:920px;margin:28px auto;padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{font-size:20px;margin:0}
  .controls{display:flex;gap:8px;align-items:center}
  .controls input,.controls select{background:#071426;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px;border-radius:8px}
  .chat{margin-top:16px;display:flex;flex-direction:column;gap:12px;max-height:62vh;overflow:auto;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))}
  .msg{display:flex;gap:10px;align-items:flex-start}
  .avatar{width:40px;height:40px;border-radius:10px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted)}
  .bubble{padding:10px 12px;border-radius:12px;max-width:78%;white-space:pre-wrap}
  .user .bubble{background:linear-gradient(90deg, rgba(14,165,164,0.12), rgba(14,165,164,0.06));border:1px solid rgba(14,165,164,0.12);color:#d8fffd}
  .assistant .bubble{background:linear-gradient(90deg, rgba(16,185,129,0.06), rgba(16,185,129,0.03));border:1px solid rgba(16,185,129,0.06);color:#dfffe9}
  .meta{font-size:12px;color:var(--muted);margin-top:6px}
  .composer{display:flex;gap:8px;margin-top:12px}
  textarea{flex:1;min-height:56px;border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.03);background:#071426;color:var(--muted);resize:vertical}
  button{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:white;cursor:pointer}
  .small{font-size:13px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);color:var(--muted)}
  .loading{display:inline-block; margin-left:8px; font-size:13px; color:var(--muted)}
  .sys-note{font-size:13px;color:var(--muted);margin-top:8px}
  .row{display:flex;gap:8px;align-items:center}
  .tag{font-size:12px;padding:6px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);color:var(--muted)}
  /* markdown simple styles */
  .bubble pre{background:transparent;border-radius:8px;padding:8px;margin:8px 0;overflow:auto}
  .bubble code{background:rgba(0,0,0,0.2);padding:2px 6px;border-radius:6px;font-family:monospace}
  a{color:inherit;text-decoration:underline}
</style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <h1>Minha IA Local — Chat</h1>
      <div class="controls">
        <label class="tag">API:</label>
        <input id="apiBase" value="http://localhost:1234/v1" title="Base URL do servidor local (LM Studio / Ollama)" />
        <label class="tag">Modelo:</label>
        <input id="model" value="mistral" title="Nome do modelo no LM Studio" />
        <button id="clearBtn" class="small" title="Limpar histórico">Limpar</button>
      </div>
    </header>

    <div class="chat" id="chat" aria-live="polite"></div>

    <div class="composer">
      <textarea id="prompt" placeholder="Escreva sua mensagem..."></textarea>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button id="sendBtn">Enviar</button>
        <button id="saveBtn" class="small">Salvar</button>
      </div>
    </div>

    <div class="row sys-note">
      <span id="status">Pronto.</span>
      <span class="loading" id="loading" style="display:none">⏳ Enviando...</span>
    </div>

    <div class="sys-note">
      Dica: o chat salva localmente (localStorage). Edite a API/PORTA se necessário. Se der CORS, ative o servidor local do LM Studio ou use proxy.
    </div>
  </div>

<script>
/*
  Chat local para LM Studio / servidor local.
  - Ajuste API_BASE e MODEL via inputs no topo.
  - Funcionalidades: histórico, salvar/load do localStorage, render Markdown simples.
  - Uso: POST a <API_BASE>/chat/completions com { model, messages }
*/

const chatEl = document.getElementById('chat');
const promptEl = document.getElementById('prompt');
const sendBtn = document.getElementById('sendBtn');
const apiBaseInput = document.getElementById('apiBase');
const modelInput = document.getElementById('model');
const statusEl = document.getElementById('status');
const loadingEl = document.getElementById('loading');
const clearBtn = document.getElementById('clearBtn');
const saveBtn = document.getElementById('saveBtn');

const STORAGE_KEY = 'minha_ia_local_hist_v1';
let history = loadHistory() || [];

// render inicial
renderAll();

// eventos
sendBtn.addEventListener('click', sendMessage);
promptEl.addEventListener('keydown', (e) => { if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)) sendMessage(); });
clearBtn.addEventListener('click', clearHistory);
saveBtn.addEventListener('click', () => { saveHistory(); setStatus('Histórico salvo.'); });

function setStatus(text){
  statusEl.textContent = text;
}

function setLoading(on){
  loadingEl.style.display = on ? 'inline-block' : 'none';
}

function createMsgEl(role, text){
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');

  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.textContent = role === 'user' ? 'U' : 'IA';

  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = renderMarkdown(text);

  wrapper.appendChild(avatar);
  wrapper.appendChild(bubble);

  return wrapper;
}

function renderAll(){
  chatEl.innerHTML = '';
  history.forEach(m => {
    chatEl.appendChild(createMsgEl(m.role, m.content));
  });
  chatEl.scrollTop = chatEl.scrollHeight;
}

function addToHistory(role, content){
  history.push({ role, content, t: Date.now() });
  // limit to last 200 messages
  if(history.length > 200) history = history.slice(history.length - 200);
  renderAll();
  saveHistoryDebounced();
}

let saveTimer;
function saveHistoryDebounced(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(() => saveHistory(), 800);
}

function saveHistory(){
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
  } catch(e){
    console.warn('Salvar falhou', e);
  }
}

function loadHistory(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch(e){
    return [];
  }
}

function clearHistory(){
  if(!confirm('Limpar todo o histórico local?')) return;
  history = [];
  saveHistory();
  renderAll();
  setStatus('Histórico limpo.');
}

async function sendMessage(){
  const text = promptEl.value.trim();
  if(!text) return;
  promptEl.value = '';
  addToHistory('user', text);
  setStatus('Enviando para o modelo...');
  setLoading(true);

  const apiBase = apiBaseInput.value.replace(/\/+$/, '');
  const model = modelInput.value || 'mistral';

  // montar payload no estilo OpenAI/LM Studio (ajuste se necessário)
  const payload = {
    model,
    messages: history.map(h => ({ role: h.role, content: h.content })),
    temperature: 0.2,
    max_tokens: 1024
  };

  // mostra mensagem assistente temporária (loading)
  const loadingAssistantIndex = history.length;
  addToHistory('assistant', '...');

  try {
    const res = await fetch(`${apiBase}/chat/completions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const textErr = await res.text();
      // substituir mensagem de '...' por erro
      history[loadingAssistantIndex] = { role: 'assistant', content: `Erro: ${res.status} ${res.statusText}\n\n${truncate(textErr,600)}` };
      renderAll();
      setStatus('Resposta com erro.');
      setLoading(false);
      return;
    }

    const data = await res.json();
    // Muitos servidores locais retornam algo como: { id, object, choices:[{message:{role,content}}] }
    const assistantText = extractAssistantText(data);
    // substituir '...' pela resposta real
    history[loadingAssistantIndex] = { role: 'assistant', content: assistantText };
    renderAll();
    setStatus('Resposta recebida.');
  } catch (err) {
    history[loadingAssistantIndex] = { role: 'assistant', content: `Erro de conexão: ${err.message}` };
    renderAll();
    setStatus('Falha na requisição.');
  } finally {
    setLoading(false);
  }
}

// util: pegar texto da resposta (compatível com LM Studio / OpenAI-like)
function extractAssistantText(data){
  try {
    if(Array.isArray(data.choices)){
      // pega primeira choice com message.content
      for(const c of data.choices){
        if(c.message && c.message.content) return c.message.content;
        if(c.delta && c.delta.content) return c.delta.content; // streaming delta case
        if(typeof c.text === 'string') return c.text;
      }
    }
    // fallback: procurar em data.response
    if(data.response && typeof data.response === 'string') return data.response;
    return JSON.stringify(data, null, 2).slice(0, 2000);
  } catch(e){
    return 'Resposta não pôde ser decodificada.';
  }
}

// mini-markdown renderer (segurança: escapa HTML)
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"
  })[s]);
}

function renderMarkdown(md){
  if(!md) return '';
  // simples conversões: code blocks, inline code, bold, italics, links, line breaks
  let s = escapeHtml(md);
  // code blocks ``` ```
  s = s.replace(/```([\s\S]*?)```/g, (m, p1) => `<pre><code>${p1.replace(/</g,'&lt;')}</code></pre>`);
  // inline code `x`
  s = s.replace(/`([^`\n]+?)`/g, '<code>$1</code>');
  // bold **text**
  s = s.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
  // italics *text*
  s = s.replace(/\*([^\*]+)\*/g, '<em>$1</em>');
  // links [text](url)
  s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
  // simple line breaks
  s = s.replace(/\n/g, '<br/>');
  return s;
}

function truncate(s, n){ return s && s.length > n ? s.slice(0,n) + '…' : s; }

// inicial auto-fill
(function init(){
  // se não existir histórico, coloca uma mensagem do sistema
  if(!history || history.length === 0){
    history = [
      { role: 'assistant', content: 'Olá — estou pronto. Digite algo e pressione Enviar. (Mensagem salva localmente.)' }
    ];
    saveHistory();
  }
  renderAll();
})();
</script>
</body>
</html>
